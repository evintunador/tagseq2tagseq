"""
Data structures for DS2DS generation results.

Defines GeneratedDocument and GenerationResult classes for storing and
accessing the outputs of a generation run.
"""
from dataclasses import dataclass
from typing import List, Literal, Optional, Union
from pathlib import Path

import numpy as np


@dataclass
class GeneratedDocument:
    """Represents a single document in the generation result."""
    
    title: str  # Original title as generated by model (non-normalized, no hash)
    title_normalized: str  # Normalized+hashed title for filesystem (e.g., "new_topic_3a7f2c")
    tokens: Optional[np.ndarray]  # Token IDs (may be None for corpus docs if only text loaded)
    text: Optional[str]  # Decoded text (may be None if only tokens stored)
    source: Union[Literal["generated", "corpus"], Path]  # Where doc came from; Path for corpus
    is_root: bool  # Whether this is the root document
    parent_title: Optional[str]  # Title of document that linked to this one (None for root)
    
    def __post_init__(self):
        """Validate that at least one of tokens or text is provided."""
        if self.tokens is None and self.text is None:
            raise ValueError(
                f"GeneratedDocument '{self.title}' must have at least one of "
                f"tokens or text non-None"
            )


@dataclass
class GenerationResult:
    """Complete result of a generation run."""
    
    root_document: GeneratedDocument
    auxiliary_documents: List[GeneratedDocument]
    # Ordering: Topologically sorted where possible (dependencies before dependents),
    # with ties broken by creation/access order.
    # Future: Could use a graph structure with explicit edges, but list is simpler for MVP.
    
    # Metadata
    generation_config: dict  # Parameters used for generation
    
    def get_all_documents(self) -> List[GeneratedDocument]:
        """
        Return all documents (root + auxiliary) in order.
        
        Returns:
            List with root document first, followed by auxiliary documents
        """
        return [self.root_document] + self.auxiliary_documents
    
    def get_document_by_title(self, title: str) -> Optional[GeneratedDocument]:
        """
        Retrieve a document by its title.
        
        Matches against both original title and normalized+hashed title.
        
        Args:
            title: Title to search for (can be original or normalized+hashed)
            
        Returns:
            GeneratedDocument if found, None otherwise
            
        Examples:
            >>> result.get_document_by_title("Python")
            GeneratedDocument(title="Python", ...)
            >>> result.get_document_by_title("python_a7f8c3")
            GeneratedDocument(title="Python", ...)  # Same document
        """
        for doc in self.get_all_documents():
            if doc.title == title or doc.title_normalized == title:
                return doc
        return None
    
    def get_generated_documents(self) -> List[GeneratedDocument]:
        """
        Return only documents that were generated (not from corpus).
        
        Returns:
            List of GeneratedDocuments where source == "generated"
        """
        return [doc for doc in self.get_all_documents() if doc.source == "generated"]
    
    def get_corpus_documents(self) -> List[GeneratedDocument]:
        """
        Return only documents that came from the corpus.
        
        Returns:
            List of GeneratedDocuments where source is a Path or "corpus"
        """
        return [
            doc for doc in self.get_all_documents()
            if doc.source == "corpus" or isinstance(doc.source, Path)
        ]
    
    def get_document_count(self) -> int:
        """
        Get total number of documents in result.
        
        Returns:
            Total count (root + auxiliary)
        """
        return 1 + len(self.auxiliary_documents)
    
    def __repr__(self) -> str:
        """Readable representation of the generation result."""
        total_docs = self.get_document_count()
        generated_count = len(self.get_generated_documents())
        corpus_count = len(self.get_corpus_documents())
        
        return (
            f"GenerationResult("
            f"total_docs={total_docs}, "
            f"generated={generated_count}, "
            f"corpus={corpus_count}, "
            f"root='{self.root_document.title}'"
            f")"
        )
